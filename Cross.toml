[target.aarch64-unknown-linux-gnu]
image = "ghcr.io/cross-rs/aarch64-unknown-linux-gnu@sha256:1e2a0291f92a4372cbc22d8994e735473045383f1ce7fa44a16c234ba00187f4"
pre-build = [
    "dpkg --add-architecture arm64",
    "apt-get update",
    "apt-get install -y pkg-config:arm64 libc6-dev:arm64",
    "apt-get install -y zlib1g-dev:arm64 libssl-dev:arm64 libsasl2-dev:arm64",
    
    # The cross toolchain restricts cmake to search in /usr/aarch64-linux-gnu
    # But multiarch installs to /usr/lib/aarch64-linux-gnu
    # Create the expected directory structure with symlinks
    "mkdir -p /usr/aarch64-linux-gnu/lib /usr/aarch64-linux-gnu/include",
    
    # Symlink zlib files to where cmake will find them
    "ln -sf /usr/lib/aarch64-linux-gnu/libz.so /usr/aarch64-linux-gnu/lib/",
    "ln -sf /usr/lib/aarch64-linux-gnu/libz.a /usr/aarch64-linux-gnu/lib/",
    "cp /usr/include/zlib.h /usr/include/zconf.h /usr/aarch64-linux-gnu/include/",
    
    # Symlink SSL files
    "ln -sf /usr/lib/aarch64-linux-gnu/libssl.so.1.1 /usr/aarch64-linux-gnu/lib/libssl.so",
    "ln -sf /usr/lib/aarch64-linux-gnu/libcrypto.so.1.1 /usr/aarch64-linux-gnu/lib/libcrypto.so",
    "ln -sf /usr/lib/aarch64-linux-gnu/libssl.a /usr/aarch64-linux-gnu/lib/",
    "ln -sf /usr/lib/aarch64-linux-gnu/libcrypto.a /usr/aarch64-linux-gnu/lib/",
    "cp -r /usr/include/openssl /usr/aarch64-linux-gnu/include/",
    
    # Debug - verify files are in place
    "echo '=== ZLIB CHECK ==='",
    "ls -la /usr/aarch64-linux-gnu/lib/libz*",
    "ls -la /usr/aarch64-linux-gnu/include/zlib.h",
]

[target.aarch64-unknown-linux-gnu.env]
PKG_CONFIG_PATH = "/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
PKG_CONFIG_ALLOW_CROSS = "1"
LIBRDKAFKA_SSL_VENDORED = "1"