[target.aarch64-unknown-linux-gnu]
image = "ghcr.io/cross-rs/aarch64-unknown-linux-gnu@sha256:1e2a0291f92a4372cbc22d8994e735473045383f1ce7fa44a16c234ba00187f4"
pre-build = [
    # Add multiarch support
    "dpkg --add-architecture arm64",
    "apt-get update",
    
    # Install base dev packages FIRST (creates pkgconfig dir structure)
    "apt-get install -y pkg-config:arm64 libc6-dev:arm64",
    
    # Install zlib and other deps
    "apt-get install -y zlib1g-dev:arm64 libssl-dev:arm64 libsasl2-dev:arm64 libzstd-dev:arm64 liblz4-dev:arm64",
    
    # Verify pkg-config finds zlib
    "pkg-config --cflags --libs --exists zlib || (echo 'ZLIB PC FAILED'; exit 1)",
    
    # Fix library paths (ensure symlinks)
    "ln -sf /usr/lib/aarch64-linux-gnu/libz.so.1 /usr/lib/aarch64-linux-gnu/libz.so",
    "ln -sf /usr/lib/aarch64-linux-gnu/libssl.so.1.1 /usr/lib/aarch64-linux-gnu/libssl.so",
    "ln -sf /usr/lib/aarch64-linux-gnu/libcrypto.so.1.1 /usr/lib/aarch64-linux-gnu/libcrypto.so",
    
    # Debug verification
    "echo '=== ZLIB DEBUG ==='",
    "dpkg -l '*zlib*' | grep '^ii'",
    "find /usr -name 'zlib.pc' 2>/dev/null || echo 'NO zlib.pc'",
    "pkg-config --cflags --libs zlib",
    "ls -la /usr/lib/aarch64-linux-gnu/libz*",
    "echo '=== PATHS ==='",
    "ls -la /usr/lib/aarch64-linux-gnu/pkgconfig/ 2>/dev/null || echo 'NO PKGCONFIG DIR'",
]

[target.aarch64-unknown-linux-gnu.env]
# Force pkg-config to cross paths
PKG_CONFIG_PATH = "/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
PKG_CONFIG_ALLOW_CROSS = "1"
LIBRDKAFKA_SSL_VENDORED = "1"

# Explicit zlib paths for cmake
ZLIB_INCLUDE_DIR = "/usr/include"
ZLIB_LIBRARY = "/usr/lib/aarch64-linux-gnu/libz.so"

# Explicit openssl paths
OPENSSL_ROOT_DIR = "/usr"
OPENSSL_INCLUDE_DIR = "/usr/include"
OPENSSL_CRYPTO_LIBRARY = "/usr/lib/aarch64-linux-gnu/libcrypto.so"
OPENSSL_SSL_LIBRARY = "/usr/lib/aarch64-linux-gnu/libssl.so"

# Debug
RUST_BACKTRACE = "1"
CROSS_NO_WARNINGS = "0"
